// Generated by CoffeeScript 2.0.0-beta4
(function() {
  // Connect to the Socket.io server
  var first_connect, socket, subscriptions,
    slice = [].slice;

  socket = io.connect();

  // Call a remote service's method
  window.remote = function(service, method, ...args) {
    var cb, i, ref;
    ref = args, args = 2 <= ref.length ? slice.call(ref, 0, i = ref.length - 1) : (i = 0, []), cb = ref[i++];
    return socket.emit('remote', service, method, ...args, cb);
  };

  // Subscribe to a service's events
  subscriptions = {};

  window.subscribe = function(service, type, cb) {
    var base;
    subscriptions[service] || (subscriptions[service] = {});
    (base = subscriptions[service])[type] || (base[type] = []);
    subscriptions[service][type].push(cb);
    return socket.emit('subscribe', service, type);
  };

  // Handle published events
  socket.on('event', function(service, type, event) {
    var cbs;
    console.log('[socket.on event]');
    console.log(arguments);
    if (cbs = subscriptions[service][type]) {
      return cbs.map(function(cb) {
        return cb(event);
      });
    }
  });

  // Resubscribe when reconnecting
  first_connect = true;

  socket.on('hello', function() {
    var fns, results, service, type, types;
    // Prevent re-connecting on initial load
    if (first_connect) {
      first_connect = false;
      return;
    }
    results = [];
    // Re-connect known subscriptions
    for (service in subscriptions) {
      types = subscriptions[service];
      results.push((function() {
        var results1;
        results1 = [];
        for (type in types) {
          fns = types[type];
          results1.push(socket.emit('subscribe', service, type));
        }
        return results1;
      })());
    }
    return results;
  });

  // Make a reference to h
  window.h = highland;

  // Creating event streams
  window.eventStream = function(service, event) {
    var stream;
    stream = h();
    subscribe(service, event, function(value) {
      return stream.write(value);
    });
    return stream;
  };

  // Log helper
  window.log = h.curry(function(s, v) {
    if (!(typeof v === "function" ? v(console.log(s)) : void 0)) {

    } else {
      return console.log('[' + s + ']', v);
    }
  });

}).call(this);
